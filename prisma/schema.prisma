// Schéma Prisma amélioré avec optimisations et bonnes pratiques

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
//                        AUTHENTIFICATION
// ============================================================

model User {
  id            String  @id @default(cuid())
  name          String
  email         String
  emailVerified Boolean @default(false) // Valeur par défaut
  image         String?
  slug          String? @unique // Pour les URLs SEO-friendly

  // Timestamps avec valeurs par défaut
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sessions               Session[]
  accounts               Account[]
  profile                Profile?
  badges                 UserBadge[]
  consent                UserConsent?
  gdprRequests           GDPRRequest[]
  posts                  Post[] // Ajout pour le contenu utilisateur
  notifications          UserNotificationStatus[] @relation("UserNotifications")
  processedRegistrations AbcRegistration[]        @relation("AbcRegistrationProcessor")
  actions                Action[] // Actions créées par l'utilisateur
  historyConfigs         HistoryConfig[] // Configurations d'histoire modifiées

  // Modération améliorée
  role       Role       @default(user) // Enum en majuscules
  status     UserStatus @default(ACTIVE) // Nouveau : statut utilisateur
  banned     Boolean?   @default(false)
  banReason  String?
  banExpires DateTime?
  bannedBy   String? // ID de l'admin qui a banni

  // Sécurité
  lastLoginAt  DateTime?
  lastLoginIp  String?
  failedLogins Int       @default(0)
  lockedUntil  DateTime?

  // RGPD et confidentialité
  dataRetention         DateTime? // Date d'expiration des données
  deletedAt             DateTime? // Soft delete
  places                Place[]                @relation("PlaceOwner")
  reviews               Review[]
  favorites             Favorite[]
  placeClaims           PlaceClaim[]
  events                Event[]                @relation("EventOrganizer")
  eventParticipations   EventParticipant[]
  eventReminders        EventReminder[]
  newsletterCampaigns   NewsletterCampaign[]
  newsletterAttachments NewsletterAttachment[]
  abcMember             AbcMember?
  abcMeetingsCreated    AbcMeeting[]           @relation("AbcMeetingCreator")
  abcDocumentsUploaded  AbcDocument[]          @relation("AbcDocumentUploader")
  abcBulletinsCreated   AbcBulletin[]          @relation("AbcBulletinCreator")
  whatsappBotConfigs    WhatsAppBotConfig[]
  googleDriveToken      GoogleDriveToken?

  // Index pour les performances
  @@unique([email])
  @@index([email])
  @@index([slug])
  @@index([role])
  @@index([status])
  @@index([createdAt])
  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now()) // Valeur par défaut
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Sécurité avancée
  impersonatedBy String?
  deviceInfo     Json? // Informations sur l'appareil
  isActive       Boolean   @default(true)
  revokedAt      DateTime?

  @@unique([token])
  @@index([userId])
  @@index([expiresAt])
  @@index([isActive])
  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String? // Hash du mot de passe
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Métadonnées de connexion
  firstLoginAt DateTime?
  lastUsedAt   DateTime?

  @@unique([providerId, accountId]) // Contrainte composite
  @@index([userId])
  @@index([providerId])
  @@map("account")
}

model Verification {
  id         String           @id @default(cuid())
  identifier String // Email ou téléphone
  value      String // Code ou token
  type       VerificationType @default(EMAIL) // Type de vérification
  expiresAt  DateTime
  used       Boolean          @default(false) // Marquer comme utilisé
  attempts   Int              @default(0) // Nombre de tentatives
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  @@index([identifier, type])
  @@index([expiresAt])
  @@map("verification")
}

// ============================================================
//                        PROFIL ET BADGES
// ============================================================

model Profile {
  id        String  @id @default(cuid())
  firstname String?
  lastname  String?
  bio       String?
  phone     String?
  address   String?
  socials   Json? // Réseaux sociaux

  // Préférences utilisateur
  language String? @default("fr")
  timezone String? @default("Europe/Paris")
  theme    Theme?  @default(SYSTEM)

  // Visibilité et confidentialité
  isPublic  Boolean @default(true)
  showEmail Boolean @default(false)
  showPhone Boolean @default(false)

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("profile")
}

model Badge {
  id          String        @id @default(cuid())
  title       String
  description String
  iconUrl     String?
  color       String?       @default("#3B82F6") // Couleur du badge
  category    BadgeCategory @default(GENERAL) // Catégorie de badge
  rarity      BadgeRarity   @default(COMMON) // Rareté
  isActive    Boolean       @default(true) // Peut être désactivé

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  users     UserBadge[]

  @@index([category])
  @@index([isActive])
  @@map("badge")
}

model UserBadge {
  id       String   @id @default(cuid())
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId   String
  badge    Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  badgeId  String
  earnedAt DateTime @default(now())

  // Métadonnées
  reason    String? // Raison d'obtention du badge
  isVisible Boolean @default(true) // L'utilisateur peut masquer ses badges

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
  @@index([earnedAt])
  @@map("user_badge")
}

// ============================================================
//                        RGPD AMÉLIORÉ
// ============================================================

model UserConsent {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Consentements détaillés
  cookies         Boolean @default(false)
  analytics       Boolean @default(false)
  marketing       Boolean @default(false)
  personalization Boolean @default(false) // Personnalisation
  communication   Boolean @default(false) // Communications

  // Métadonnées améliorées
  consentDate    DateTime      @default(now())
  consentVersion String        @default("1.0") // Version de la politique
  ipAddress      String?
  userAgent      String?
  source         ConsentSource @default(BANNER) // Source du consentement

  // Gestion des retraits
  withdrawnAt    DateTime?
  withdrawReason String?

  // Historique enrichi (JSON pour MVP)
  history Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([consentDate])
  @@map("user_consents")
}

model GDPRRequest {
  id     String  @id @default(cuid())
  userId String? // Peut être null si utilisateur supprimé
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Informations de base enrichies
  type      GDPRType
  email     String
  firstName String?
  lastName  String?
  phone     String?
  status    RequestStatus   @default(PENDING)
  priority  RequestPriority @default(NORMAL)

  // Contenu détaillé
  subject     String?
  message     String
  attachments String[] // URLs des pièces jointes
  response    String?

  // Traitement
  assignedTo    String? // ID de l'admin assigné
  processedBy   String? // ID de l'admin qui a traité
  internalNotes String? // Notes internes

  // Dates et délais
  requestDate   DateTime  @default(now())
  dueDate       DateTime? // Date limite légale (30 jours)
  processedDate DateTime?
  reminderSent  Boolean   @default(false)

  // Métadonnées
  ipAddress String?
  userAgent String?
  source    RequestSource @default(WEB_FORM)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([email])
  @@index([status])
  @@index([type])
  @@index([requestDate])
  @@index([dueDate])
  @@map("gdpr_requests")
}

// ============================================================
//                        CONTENU (NOUVEAU)
// ============================================================

model Post {
  id          String    @id @default(cuid())
  title       String
  slug        String    @unique
  content     String?   @db.Text // Type TEXT pour le contenu long
  excerpt     String?
  published   Boolean   @default(false)
  publishedAt DateTime?

  // Relations
  authorId   String
  author     User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  categoryId String?
  category   Category?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  placeId    String?    // Articles liés à un lieu (optionnel - null pour articles de l'association)
  place      Place?     @relation("PlacePosts", fields: [placeId], references: [id], onDelete: SetNull)
  tags       PostTag[]
  views      PostView[]

  // Image de couverture
  coverImage String?

  // SEO amélioré
  metaTitle       String?
  metaDescription String? @db.VarChar(160) // Limite SEO
  ogImage         String?
  canonicalUrl    String?

  // Statistiques
  viewCount    Int @default(0)
  likeCount    Int @default(0)
  commentCount Int @default(0)

  // Modération
  status          PostStatus @default(DRAFT)
  moderatedBy     String?
  moderatedAt     DateTime?
  moderationNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([authorId])
  @@index([placeId])
  @@index([published])
  @@index([status])
  @@index([publishedAt])
  @@index([createdAt])
  @@map("posts")
}

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?
  color       String?    @default("#6B7280")
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  posts       Post[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([parentId])
  @@map("categories")
}

model Tag {
  id    String    @id @default(cuid())
  name  String    @unique
  slug  String    @unique
  color String?   @default("#8B5CF6")
  posts PostTag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@map("tags")
}

model PostTag {
  id     String @id @default(cuid())
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId String
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagId  String

  @@unique([postId, tagId])
  @@index([postId])
  @@index([tagId])
  @@map("post_tags")
}

model PostView {
  id     String @id @default(cuid())
  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  // Informations de tracking
  ipAddress String
  userAgent String @default("")
  referer   String @default("")

  // Géolocalisation (optionnel)
  country String?
  region  String?
  city    String?

  createdAt DateTime @default(now())

  @@index([postId])
  @@index([ipAddress])
  @@index([createdAt])
  @@map("post_views")
}

// ============================================================
//                    ÉTAPE 1 : PLACES CORE (MVP)
// ============================================================

model Place {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  type        PlaceType @default(OTHER)
  category    String? // Sous-catégorie libre pour flexibilité (deprecated, use categories relation)
  description String?   @db.Text
  summary     String?   @db.VarChar(280) // Pour partage Twitter

  // Statut
  status     PlaceStatus @default(DRAFT)
  isVerified Boolean     @default(false)
  isActive   Boolean     @default(true)
  isFeatured Boolean     @default(false)

  // Google Business Integration
  googlePlaceId      String?   @unique // Place ID de Google
  googleMapsUrl      String? // URL Google Maps
  googleBusinessData Json? // Données cachées de Google My Business
  lastGoogleSync     DateTime? // Dernière synchro

  // Propriétaire
  ownerId   String?
  owner     User?     @relation("PlaceOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  claimedAt DateTime? // Date de revendication

  // Contact principal
  email   String?
  phone   String?
  website String?

  // Localisation (requis pour Google Places)
  street       String
  streetNumber String?
  postalCode   String
  city         String
  latitude     Float?
  longitude    Float?

  // Réseaux sociaux pour partage
  facebook  String?
  instagram String?
  twitter   String?
  linkedin  String?
  tiktok    String?

  // Médias
  logo       String?
  coverImage String?
  images     Json? // ["url1", "url2"] pour MVP

  // SEO & Partage social
  metaTitle       String? @db.VarChar(60)
  metaDescription String? @db.VarChar(160)
  ogImage         String? // Image pour partage réseaux sociaux

  // Statistiques
  viewCount   Int    @default(0)
  shareCount  Int    @default(0)
  rating      Float? @default(0)
  reviewCount Int    @default(0)

  // Relations MVP
  openingHours  OpeningHours[]
  reviews       Review[]
  googleReviews GoogleReview[]
  favorites     Favorite[]
  claims        PlaceClaim[]
  categories    PlaceToCategory[] // Many-to-many avec PlaceCategory
  events        Event[] // Événements organisés dans cette place
  posts         Post[]  @relation("PlacePosts") // Articles liés à ce lieu
  products      Product[] @relation("PlaceProducts") // Produits proposés
  services      Service[] @relation("PlaceServices") // Services proposés
  offers        Offer[] @relation("PlaceOffers") // Offres et promotions

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([type])
  @@index([status])
  @@index([googlePlaceId])
  @@index([postalCode, city])
  @@index([latitude, longitude])
  @@map("places")
}

// ============================================================
//                    PRODUITS ET SERVICES
// ============================================================

model Product {
  id          String  @id @default(cuid())
  name        String
  slug        String
  description String? @db.Text
  summary     String? @db.VarChar(280)

  // Prix et détails
  price       Float?
  priceType   ProductPriceType @default(FIXED)
  currency    String           @default("EUR")
  unit        String? // "par heure", "par kg", etc.
  
  // Statut et visibilité
  status     ProductStatus @default(DRAFT)
  isActive   Boolean       @default(true)
  isFeatured Boolean       @default(false)
  
  // Disponibilité
  isAvailable   Boolean @default(true)
  stock         Int?
  minQuantity   Int?    @default(1)
  maxQuantity   Int?
  
  // Médias
  coverImage String? // Image principale du produit
  images Json? // ["url1", "url2"] galerie d'images
  
  // Catégorisation
  category    String?
  tags        Json? // ["tag1", "tag2"] pour MVP
  
  // Caractéristiques techniques
  specifications Json? // Spécifications techniques libres
  
  // Relation avec la place
  placeId String
  place   Place  @relation("PlaceProducts", fields: [placeId], references: [id], onDelete: Cascade)
  
  // Statistiques
  viewCount  Int @default(0)
  orderCount Int @default(0)
  
  // SEO
  metaTitle       String?
  metaDescription String? @db.VarChar(160)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations avec les offres
  offers ProductOffer[]

  @@index([placeId])
  @@index([status])
  @@index([isActive])
  @@index([category])
  @@index([slug])
  @@map("products")
}

model Service {
  id          String  @id @default(cuid())
  name        String
  slug        String
  description String? @db.Text
  summary     String? @db.VarChar(280)

  // Prix et détails
  price     Float?
  priceType ServicePriceType @default(FIXED)
  currency  String           @default("EUR")
  unit      String? // "par heure", "par intervention", etc.
  duration  Int? // Durée en minutes
  
  // Statut et visibilité
  status     ServiceStatus @default(DRAFT)
  isActive   Boolean       @default(true)
  isFeatured Boolean       @default(false)
  
  // Disponibilité
  isAvailable    Boolean @default(true)
  requiresBooking Boolean @default(false)
  
  // Médias
  coverImage String? // Image principale du produit
  images Json? // ["url1", "url2"] galerie d'images
  
  // Catégorisation
  category String?
  tags     Json? // ["tag1", "tag2"] pour MVP
  
  // Caractéristiques
  features Json? // Caractéristiques du service
  
  // Relation avec la place
  placeId String
  place   Place  @relation("PlaceServices", fields: [placeId], references: [id], onDelete: Cascade)
  
  // Statistiques
  viewCount    Int @default(0)
  bookingCount Int @default(0)
  
  // SEO
  metaTitle       String?
  metaDescription String? @db.VarChar(160)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations avec les offres
  offers ServiceOffer[]

  @@index([placeId])
  @@index([status])
  @@index([isActive])
  @@index([category])
  @@index([slug])
  @@map("services")
}

model Offer {
  id          String  @id @default(cuid())
  title       String
  slug        String
  description String? @db.Text
  summary     String? @db.VarChar(280)

  // Type d'offre
  type OfferType @default(DISCOUNT)
  
  // Réduction
  discountType       DiscountType @default(PERCENTAGE)
  discountValue      Float
  discountMaxAmount  Float? // Montant max pour % 
  minimumPurchase    Float? // Achat minimum requis
  
  // Validité
  status    OfferStatus @default(DRAFT)
  isActive  Boolean     @default(true)
  startDate DateTime?
  endDate   DateTime?
  
  // Limitations
  maxUses         Int? // Nombre max d'utilisations total
  maxUsesPerUser  Int? @default(1)
  currentUses     Int  @default(0)
  
  // Code promotionnel
  code        String? @unique
  requiresCode Boolean @default(false)
  
  // Médias
  coverImage String? // Image principale de l'offre
  images Json? // ["url1", "url2"] galerie d'images
  
  // Relation avec la place
  placeId String
  place   Place  @relation("PlaceOffers", fields: [placeId], references: [id], onDelete: Cascade)
  
  // Relations avec produits/services
  products ProductOffer[]
  services ServiceOffer[]
  
  // Statistiques
  viewCount Int @default(0)
  useCount  Int @default(0)
  
  // SEO
  metaTitle       String?
  metaDescription String? @db.VarChar(160)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([placeId])
  @@index([status])
  @@index([isActive])
  @@index([code])
  @@index([startDate])
  @@index([endDate])
  @@index([slug])
  @@map("offers")
}

// Tables de liaison pour les offres
model ProductOffer {
  id        String @id @default(cuid())
  productId String
  offerId   String
  
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  offer   Offer   @relation(fields: [offerId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([productId, offerId])
  @@index([productId])
  @@index([offerId])
  @@map("product_offers")
}

model ServiceOffer {
  id        String @id @default(cuid())
  serviceId String
  offerId   String
  
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  offer   Offer   @relation(fields: [offerId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([serviceId, offerId])
  @@index([serviceId])
  @@index([offerId])
  @@map("service_offers")
}

// ============================================================
//                    CATÉGORIES DE PLACES
// ============================================================

model PlaceCategory {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  description String? @db.Text

  // Apparence visuelle
  icon        String? // Nom de l'icône Lucide ou emoji
  color       String? @default("#6B7280") // Couleur hexadécimale
  bgColor     String? @default("bg-gray-100") // Classe Tailwind background
  textColor   String? @default("text-gray-700") // Classe Tailwind texte
  borderColor String? @default("border-gray-200") // Classe Tailwind bordure

  // Configuration
  isActive  Boolean @default(true)
  sortOrder Int     @default(0) // Pour l'ordre d'affichage

  // Métadonnées
  placeCount Int @default(0) // Cache du nombre de places

  // Relations hiérarchiques
  parentId String?
  parent   PlaceCategory?  @relation("PlaceCategoryHierarchy", fields: [parentId], references: [id])
  children PlaceCategory[] @relation("PlaceCategoryHierarchy")

  // Relations avec places
  places PlaceToCategory[] // Many-to-many avec Place

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([parentId])
  @@index([isActive])
  @@index([sortOrder])
  @@map("place_categories")
}

// Table de liaison pour la relation many-to-many Place <-> PlaceCategory
model PlaceToCategory {
  id         String @id @default(cuid())
  placeId    String
  categoryId String

  place    Place         @relation(fields: [placeId], references: [id], onDelete: Cascade)
  category PlaceCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([placeId, categoryId])
  @@index([placeId])
  @@index([categoryId])
  @@map("place_to_categories")
}

// ============================================================
//                    HORAIRES D'OUVERTURE
// ============================================================

model OpeningHours {
  id      String @id @default(cuid())
  placeId String
  place   Place  @relation(fields: [placeId], references: [id], onDelete: Cascade)

  dayOfWeek DayOfWeek
  openTime  String? // Format "HH:MM"
  closeTime String? // Format "HH:MM"
  isClosed  Boolean   @default(false)

  @@index([placeId, dayOfWeek])
  @@map("opening_hours")
}

// ============================================================
//                    AVIS GOOGLE-LIKE
// ============================================================

model Review {
  id      String @id @default(cuid())
  placeId String
  place   Place  @relation(fields: [placeId], references: [id], onDelete: Cascade)
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  rating  Int // 1-5 étoiles
  comment String? @db.Text

  // Import Google Reviews
  googleReviewId String? @unique
  isGoogleReview Boolean @default(false)

  // Réponse propriétaire
  response    String?   @db.Text
  respondedAt DateTime?

  status ReviewStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([placeId, userId])
  @@index([placeId])
  @@index([userId])
  @@index([rating])
  @@map("reviews")
}

// ============================================================
//                    AVIS GOOGLE IMPORTÉS
// ============================================================

model GoogleReview {
  id      String @id @default(cuid())
  placeId String
  place   Place  @relation(fields: [placeId], references: [id], onDelete: Cascade)

  rating  Int // 1-5 étoiles
  comment String? @db.Text

  // Informations Google
  googleReviewId String  @unique
  authorName     String
  authorUrl      String?
  googleTime     Int // Timestamp Google
  relativeTime   String? // "il y a 2 mois"

  // Réponse propriétaire
  response    String?   @db.Text
  respondedAt DateTime?

  status ReviewStatus @default(APPROVED) // Les avis Google sont automatiquement approuvés

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([placeId])
  @@index([rating])
  @@index([googleReviewId])
  @@map("google_reviews")
}

// ============================================================
//                    FAVORIS UTILISATEURS
// ============================================================

model Favorite {
  id      String @id @default(cuid())
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  placeId String
  place   Place  @relation(fields: [placeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, placeId])
  @@index([userId])
  @@index([placeId])
  @@map("favorites")
}

// ============================================================
//                    REVENDICATIONS DE PLACES
// ============================================================

model PlaceClaim {
  id      String @id @default(cuid())
  placeId String
  place   Place  @relation(fields: [placeId], references: [id], onDelete: Cascade)
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  message String      @db.Text // Message de revendication
  proof   String? // URL vers une preuve (document, photo, etc.)
  status  ClaimStatus @default(PENDING)

  // Admin qui traite la demande
  processedBy  String?
  processedAt  DateTime?
  adminMessage String? // Message de l'admin lors du traitement

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([placeId])
  @@index([userId])
  @@index([status])
  @@map("place_claims")
}

// ============================================================
//                    ACTIONS DE L'ASSOCIATION
// ============================================================

model Action {
  id          String  @id @default(cuid())
  title       String
  slug        String  @unique
  description String? @db.Text
  content     String? @db.Text
  summary     String? @db.VarChar(280) // Pour partage social

  // Images
  coverImage String? // Image de couverture principale
  gallery    String[] // Galerie d'images

  // Statut et visibilité
  status     ActionStatus @default(DRAFT)
  isActive   Boolean      @default(true)
  isFeatured Boolean      @default(false) // Mis en avant sur l'accueil

  // Dates
  startDate DateTime? // Date de début de l'action
  endDate   DateTime? // Date de fin de l'action

  // Métadonnées SEO
  metaTitle       String?
  metaDescription String?

  // Ordre d'affichage
  sortOrder Int @default(0)

  // Relations
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  @@index([status])
  @@index([isActive])
  @@index([isFeatured])
  @@index([sortOrder])
  @@index([publishedAt])
  @@map("actions")
}

// ============================================================
//                        ENUMS AMÉLIORÉS
// ============================================================

enum Role {
  user
  admin
  moderator
  dpo // Data Protection Officer
  editor // Éditeur de contenu
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
  PENDING_VERIFICATION
  DELETED
}

enum Theme {
  LIGHT
  DARK
  SYSTEM
}

enum VerificationType {
  EMAIL
  PHONE
  PASSWORD_RESET
  TWO_FACTOR
}

enum BadgeCategory {
  GENERAL
  ACHIEVEMENT
  PARTICIPATION
  SPECIAL
  ANNIVERSARY
}

enum BadgeRarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

enum ConsentSource {
  BANNER
  SETTINGS
  REGISTRATION
  API
  MIGRATION
}

enum GDPRType {
  DATA_EXPORT // Art. 15 - Droit d'accès
  DATA_DELETE // Art. 17 - Droit à l'effacement
  DATA_CORRECT // Art. 16 - Droit de rectification
  DATA_RESTRICT // Art. 18 - Droit à la limitation
  DATA_PORTABLE // Art. 20 - Droit à la portabilité
  OBJECTION // Art. 21 - Droit d'opposition
  COMPLAINT // Plainte
  CONSENT_WITHDRAW // Retrait de consentement
  OTHER
}

enum RequestStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
  EXPIRED
  CANCELLED
}

enum RequestPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum RequestSource {
  WEB_FORM
  EMAIL
  PHONE
  CHAT
  API
  ADMIN_PANEL
}

enum PostStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  ARCHIVED
  REJECTED
}

enum PlaceType {
  COMMERCE
  SERVICE
  RESTAURANT
  ARTISAN
  ADMINISTRATION
  MUSEUM
  TOURISM
  PARK
  LEISURE
  ASSOCIATION
  HEALTH
  EDUCATION
  TRANSPORT
  ACCOMMODATION
  OTHER
}

enum PlaceStatus {
  DRAFT
  PENDING
  ACTIVE
  INACTIVE
  CLOSED
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ClaimStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============================================================
//                    ÉVÉNEMENTS ET AGENDA
// ============================================================

model Event {
  id          String  @id @default(cuid())
  title       String
  slug        String  @unique
  description String? @db.Text
  summary     String? @db.VarChar(280) // Résumé court pour partage social

  // Statut et visibilité
  status      EventStatus @default(DRAFT)
  isPublished Boolean     @default(false)
  isFeatured  Boolean     @default(false)
  isActive    Boolean     @default(true)

  // Organisateur
  organizerId String?
  organizer   User?   @relation("EventOrganizer", fields: [organizerId], references: [id], onDelete: SetNull)

  // Place associée (optionnel)
  placeId String?
  place   Place?  @relation(fields: [placeId], references: [id], onDelete: SetNull)

  // Contact événement
  email     String?
  phone     String?
  website   String?
  ticketUrl String? // URL de billetterie

  // Dates et récurrence
  startDate DateTime
  endDate   DateTime
  isAllDay  Boolean  @default(false)
  timezone  String   @default("Europe/Paris")

  // Récurrence
  isRecurring      Boolean         @default(false)
  recurrenceRule   RecurrenceRule? @relation(fields: [recurrenceRuleId], references: [id])
  recurrenceRuleId String?         @unique
  parentEventId    String? // Pour les instances d'événements récurrents
  parentEvent      Event?          @relation("EventRecurrence", fields: [parentEventId], references: [id])
  instances        Event[]         @relation("EventRecurrence")

  // Localisation (si différent de la place)
  locationName         String?
  locationAddress      String?
  locationStreet       String?
  locationStreetNumber String?
  locationPostalCode   String?
  locationCity         String?
  locationLatitude     Float?
  locationLongitude    Float?

  // Google Business Integration
  googlePlaceId String?
  googleMapsUrl String?

  // Capacité et participants
  maxParticipants     Int?
  currentParticipants Int     @default(0)
  waitingList         Boolean @default(false)

  // Tarification
  isFree       Boolean @default(true)
  price        Float?
  priceDetails String? // "Adulte: 15€, Enfant: 8€"
  currency     String  @default("EUR")

  // Médias
  logo       String?
  coverImage String?
  images     Json? // ["url1", "url2"] pour galerie
  videos     Json? // URLs de vidéos

  // SEO et partage social
  metaTitle       String? @db.VarChar(60)
  metaDescription String? @db.VarChar(160)
  ogImage         String?

  // Réseaux sociaux
  facebook  String?
  instagram String?
  twitter   String?
  linkedin  String?
  tiktok    String?

  // Tags et catégories
  tags     Json? // ["musique", "concert"] pour MVP
  category EventCategory?

  // Statistiques
  viewCount        Int @default(0)
  shareCount       Int @default(0)
  participantCount Int @default(0)

  // Relations
  participants EventParticipant[]
  reminders    EventReminder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([status])
  @@index([isPublished])
  @@index([startDate])
  @@index([endDate])
  @@index([organizerId])
  @@index([placeId])
  @@index([category])
  @@index([locationCity])
  @@index([locationLatitude, locationLongitude])
  @@map("events")
}

// Règles de récurrence pour les événements
model RecurrenceRule {
  id String @id @default(cuid())

  // Type de récurrence
  frequency RecurrenceFrequency // DAILY, WEEKLY, MONTHLY, YEARLY
  interval  Int                 @default(1) // Tous les X jours/semaines/mois
  count     Int? // Nombre d'occurrences (optionnel)
  until     DateTime? // Date de fin (optionnel)

  // Jours de la semaine (pour récurrence hebdomadaire)
  byWeekDay Json? // [1,3,5] pour lundi, mercredi, vendredi

  // Jours du mois (pour récurrence mensuelle)
  byMonthDay Json? // [1,15] pour le 1er et 15 du mois

  // Mois de l'année (pour récurrence annuelle)  
  byMonth Json? // [6,12] pour juin et décembre

  // Exceptions (dates à exclure)
  exceptions Json? // ["2024-12-25", "2024-01-01"]

  // Configuration avancée
  workdaysOnly Boolean @default(false) // Exclure weekends

  event Event?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("recurrence_rules")
}

// Participants aux événements
model EventParticipant {
  id      String @id @default(cuid())
  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  status       ParticipationStatus @default(INTERESTED)
  registeredAt DateTime            @default(now())

  // Informations supplémentaires
  guestCount   Int     @default(0) // Nombre d'accompagnants
  specialNeeds String? // Besoins spéciaux, allergies, etc.
  notes        String? // Notes personnelles

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@index([status])
  @@map("event_participants")
}

// Rappels d'événements
model EventReminder {
  id      String @id @default(cuid())
  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  reminderTime DateTime // Quand envoyer le rappel
  type         ReminderType
  sent         Boolean      @default(false)
  sentAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventId, userId, reminderTime])
  @@index([eventId])
  @@index([userId])
  @@index([reminderTime])
  @@index([sent])
  @@map("event_reminders")
}

// ============================================================
//                    NOUVEAUX ENUMS POUR ÉVÉNEMENTS
// ============================================================

enum EventStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  CANCELLED
  POSTPONED
  COMPLETED
  ARCHIVED
}

enum EventCategory {
  CONFERENCE
  CONCERT
  FESTIVAL
  WORKSHOP
  SEMINAR
  EXHIBITION
  SPORT
  CULTURAL
  SOCIAL
  BUSINESS
  EDUCATIONAL
  ENTERTAINMENT
  CHARITY
  RELIGIOUS
  POLITICAL
  FAMILY
  FOOD
  HEALTH
  TECHNOLOGY
  ART
  MUSIC
  THEATER
  CINEMA
  BOOK
  NATURE
  TOURISM
  OTHER
}

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

enum ParticipationStatus {
  INTERESTED
  GOING
  MAYBE
  NOT_GOING
  CANCELLED
  WAITLISTED
}

enum ReminderType {
  EMAIL
  PUSH
  SMS
}

// ============================================================
//                    NEWSLETTER SYSTEM
// ============================================================

model NewsletterSubscriber {
  id        String  @id @default(cuid())
  email     String  @unique
  firstName String?
  lastName  String?

  // Préférences d'abonnement
  preferences NewsletterPreferences?

  // Statut
  isActive          Boolean @default(true)
  isVerified        Boolean @default(false)
  verificationToken String? @unique
  unsubscribeToken  String? @unique

  // Métadonnées
  subscribedAt  DateTime  @default(now())
  lastEmailSent DateTime?

  // Relations
  campaigns NewsletterCampaignSent[]
  queueJobs NewsletterQueue[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("newsletter_subscribers")
}

model NewsletterPreferences {
  id           String               @id @default(cuid())
  subscriberId String               @unique
  subscriber   NewsletterSubscriber @relation(fields: [subscriberId], references: [id], onDelete: Cascade)

  // Types de contenus
  events Boolean @default(true) // Événements et animations
  places Boolean @default(true) // Nouveaux commerces
  offers Boolean @default(false) // Offres et promotions
  news   Boolean @default(true) // Actualités association

  // Fréquence
  frequency NewsletterFrequency @default(WEEKLY)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("newsletter_preferences")
}

model NewsletterCampaign {
  id      String @id @default(cuid())
  title   String
  subject String
  content String @db.Text

  // Configuration
  type   NewsletterType @default(NEWSLETTER)
  status CampaignStatus @default(DRAFT)

  // Planification
  scheduledAt DateTime?
  sentAt      DateTime?

  // Contenu sélectionné
  includedEvents String[] // IDs des événements
  includedPlaces String[] // IDs des places
  includedPosts  String[] // IDs des posts

  // Statistiques
  totalRecipients   Int @default(0)
  totalSent         Int @default(0)
  totalDelivered    Int @default(0)
  totalOpened       Int @default(0)
  totalClicked      Int @default(0)
  totalUnsubscribed Int @default(0)

  // Relations
  sentCampaigns NewsletterCampaignSent[]
  attachments   NewsletterAttachment[]
  queueJobs     NewsletterQueue[]

  // Métadonnées
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("newsletter_campaigns")
}

model NewsletterCampaignSent {
  id           String               @id @default(cuid())
  campaignId   String
  campaign     NewsletterCampaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  subscriberId String
  subscriber   NewsletterSubscriber @relation(fields: [subscriberId], references: [id], onDelete: Cascade)

  // Statut de l'envoi
  status         EmailStatus @default(PENDING)
  sentAt         DateTime?
  deliveredAt    DateTime?
  openedAt       DateTime?
  clickedAt      DateTime?
  unsubscribedAt DateTime?

  // Métadonnées de l'email
  messageId    String?
  errorMessage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([campaignId, subscriberId])
  @@map("newsletter_campaign_sent")
}

// ============================================================
//                    NEWSLETTER ENUMS
// ============================================================

enum NewsletterFrequency {
  DAILY
  WEEKLY
  MONTHLY
}

enum NewsletterType {
  NEWSLETTER // Newsletter régulière
  ANNOUNCEMENT // Annonce spéciale
  EVENT_DIGEST // Digest d'événements
  PLACE_UPDATE // Nouveaux commerces
  PROMOTIONAL // Offres promotionnelles
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  CANCELLED
  ERROR
}

enum EmailStatus {
  PENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  UNSUBSCRIBED
  ERROR
  FAILED
}

// ============================================================
//                NEWSLETTER ATTACHMENTS & QUEUE
// ============================================================

model NewsletterAttachment {
  id         String             @id @default(cuid())
  campaignId String
  campaign   NewsletterCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  // Informations du fichier
  fileName     String
  originalName String
  fileType     String
  fileSize     Int // en bytes
  filePath     String // chemin relatif depuis public/

  // Métadonnées
  uploadedBy String
  uploader   User   @relation(fields: [uploadedBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([campaignId])
  @@map("newsletter_attachments")
}

model NewsletterQueue {
  id         String             @id @default(cuid())
  campaignId String
  campaign   NewsletterCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  subscriberId String
  subscriber   NewsletterSubscriber @relation(fields: [subscriberId], references: [id], onDelete: Cascade)

  // Configuration de la tâche
  priority    Int @default(0)
  attempts    Int @default(0)
  maxAttempts Int @default(3)

  // Planification
  scheduledAt DateTime
  processedAt DateTime?

  // Statut
  status QueueStatus @default(PENDING)
  error  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, scheduledAt])
  @@index([campaignId])
  @@index([subscriberId])
  @@map("newsletter_queue")
}

enum QueueStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================================
//                    ABC ASSOCIATION MANAGEMENT
// ============================================================

model AbcMember {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type   AbcMemberType
  role   AbcMemberRole   @default(MEMBRE)
  status AbcMemberStatus @default(ACTIVE)

  // Informations adhésion
  memberNumber   String?   @unique
  membershipDate DateTime? // Date d'adhésion réelle (papier ou site)
  joinedAt       DateTime  @default(now()) // Date création sur le site (pour compatibilité)
  renewedAt      DateTime? // Date du dernier renouvellement
  expiresAt      DateTime? // Date d'expiration de l'adhésion

  // Relations
  payments  AbcPayment[]
  meetings  AbcMeetingAttendee[]
  documents AbcDocumentShare[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("abc_members")
}

model AbcPayment {
  id       String    @id @default(cuid())
  memberId String
  member   AbcMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  amount Float
  mode   AbcPaymentMode
  status AbcPaymentStatus @default(PENDING)

  // Détails selon le mode
  checkNumber String? // Pour les chèques
  reference   String? // Pour les virements

  // Période de cotisation
  year    Int
  quarter Int? // 1-4 pour cotisations trimestrielles

  // Métadonnées
  paidAt DateTime?
  notes  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([memberId, year, quarter])
  @@map("abc_payments")
}

model AbcMeeting {
  id          String  @id @default(cuid())
  title       String
  description String? @db.Text

  type   AbcMeetingType   @default(GENERAL)
  status AbcMeetingStatus @default(SCHEDULED)

  // Planification
  scheduledAt DateTime
  duration    Int? // en minutes
  location    String?

  // Ordre du jour et PV
  agenda  String? @db.Text
  minutes String? @db.Text

  // Relations
  attendees AbcMeetingAttendee[]
  documents AbcDocument[]
  bulletins AbcBulletin[]

  // Métadonnées
  createdById String
  createdBy   User   @relation("AbcMeetingCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("abc_meetings")
}

model AbcMeetingAttendee {
  id        String     @id @default(cuid())
  meetingId String
  meeting   AbcMeeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  memberId  String
  member    AbcMember  @relation(fields: [memberId], references: [id], onDelete: Cascade)

  status AbcAttendanceStatus @default(INVITED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([meetingId, memberId])
  @@map("abc_meeting_attendees")
}

model AbcDocument {
  id          String  @id @default(cuid())
  title       String
  description String? @db.Text

  type     AbcDocumentType
  fileName String
  filePath String
  fileSize Int

  // Association à une réunion (optionnel)
  meetingId String?
  meeting   AbcMeeting? @relation(fields: [meetingId], references: [id], onDelete: SetNull)

  // Partage
  shares AbcDocumentShare[]

  // Métadonnées
  uploadedById String
  uploadedBy   User   @relation("AbcDocumentUploader", fields: [uploadedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("abc_documents")
}

model AbcDocumentShare {
  id         String      @id @default(cuid())
  documentId String
  document   AbcDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  memberId   String
  member     AbcMember   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  accessLevel AbcDocumentAccess @default(READ)
  sharedAt    DateTime          @default(now())

  @@unique([documentId, memberId])
  @@map("abc_document_shares")
}

model AbcBulletin {
  id      String @id @default(cuid())
  title   String
  content String @db.Text

  // Publication
  isPublished Boolean   @default(false)
  publishedAt DateTime?

  // Relations optionnelles
  meetingId String?
  meeting   AbcMeeting? @relation(fields: [meetingId], references: [id], onDelete: SetNull)

  // Métadonnées
  createdById String
  createdBy   User   @relation("AbcBulletinCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("abc_bulletins")
}

model UserNotificationStatus {
  id             String    @id @default(cuid())
  userId         String
  user           User      @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  notificationId String // Format: "bulletin-{bulletinId}" ou autre
  type           String // "NEW_BULLETIN", etc.
  isRead         Boolean   @default(false)
  readAt         DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, notificationId])
  @@map("user_notification_status")
}

model AbcRegistration {
  id String @id @default(cuid())

  // Informations personnelles
  firstName      String
  lastName       String
  commercialName String? // Dénomination commerciale
  email          String
  phone          String?
  birthDate      String? // Changé en String pour plus de flexibilité

  // Adresse (obligatoire selon le formulaire)
  address    String
  postalCode String
  city       String

  // Site Internet
  website String?

  // Informations professionnelles (optionnelles, pour compatibilité)
  profession String?
  company    String?
  siret      String?

  // Type de membership souhaité
  membershipType AbcMemberType @default(ACTIF)

  // Cotisation
  cotisationAmount Float
  paymentMethod    AbcPaymentMethod @default(CHEQUE)

  // Motivations (optionnel)
  motivation String? @db.Text
  interests  String? // JSON array of interests

  // Déclarations et acceptations
  acceptsStatuts     Boolean @default(false)
  acceptsReglement   Boolean @default(false)
  acceptsCotisation  Boolean @default(false)

  // Statut de la demande
  status        AbcRegistrationStatus @default(PENDING)
  processedAt   DateTime?
  processedBy   String?
  processorUser User?                 @relation("AbcRegistrationProcessor", fields: [processedBy], references: [id])

  // Notes admin
  adminNotes String? @db.Text

  // Fichiers
  pdfPath String? // Chemin vers le PDF généré

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([email])
  @@index([createdAt])
  @@map("abc_registrations")
}

// ============================================================
//                    ABC ENUMS
// ============================================================

enum AbcMemberType {
  ACTIF
  ARTISAN
  AUTO_ENTREPRENEUR
  PARTENAIRE
  BIENFAITEUR
}

enum AbcPaymentMethod {
  CHEQUE
  VIREMENT
  ESPECES
}

enum AbcMemberRole {
  MEMBRE
  SECRETAIRE
  TRESORIER
  PRESIDENT
  VICE_PRESIDENT
}

enum AbcMemberStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  EXPIRED
}

enum AbcPaymentMode {
  CHEQUE
  ESPECE
  VIREMENT
}

enum AbcPaymentStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

enum AbcMeetingType {
  GENERAL
  BUREAU
  EXTRAORDINAIRE
  COMMISSION
}

enum AbcMeetingStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum AbcAttendanceStatus {
  INVITED
  CONFIRMED
  PRESENT
  ABSENT
  EXCUSED
}

enum AbcDocumentType {
  MINUTES
  AGENDA
  FINANCIAL
  LEGAL
  COMMUNICATION
  OTHER
}

enum AbcDocumentAccess {
  READ
  WRITE
  ADMIN
}

enum AbcRegistrationStatus {
  PENDING // En attente de traitement
  APPROVED // Approuvée
  REJECTED // Rejetée
  PROCESSED // Traitée (membre créé)
}

enum ActionStatus {
  DRAFT // Brouillon
  PUBLISHED // Publié
  SCHEDULED // Programmé
  ARCHIVED // Archivé
}

// ============================================================
//                    PRODUITS ET SERVICES ENUMS
// ============================================================

enum ProductStatus {
  DRAFT
  PUBLISHED
  OUT_OF_STOCK
  DISCONTINUED
  ARCHIVED
}

enum ProductPriceType {
  FIXED // Prix fixe
  VARIABLE // Prix variable
  ON_REQUEST // Sur demande
  FREE // Gratuit
}

enum ServiceStatus {
  DRAFT
  PUBLISHED
  UNAVAILABLE
  DISCONTINUED
  ARCHIVED
}

enum ServicePriceType {
  FIXED // Prix fixe
  HOURLY // Par heure
  DAILY // Par jour
  VARIABLE // Prix variable
  ON_REQUEST // Sur demande
  FREE // Gratuit
}

enum OfferType {
  DISCOUNT // Réduction
  FREEBIE // Produit gratuit
  BUNDLE // Pack
  LOYALTY // Fidélité
  SEASONAL // Saisonnière
  LIMITED_TIME // Durée limitée
}

enum OfferStatus {
  DRAFT
  ACTIVE
  PAUSED
  EXPIRED
  ARCHIVED
}

enum DiscountType {
  PERCENTAGE // Pourcentage
  FIXED_AMOUNT // Montant fixe
  FREE_SHIPPING // Livraison gratuite
  BUY_X_GET_Y // Achetez X obtenez Y
}

// ============================================================
//                        PARTENAIRES
// ============================================================

model Partner {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String? @db.Text
  logo        String?
  website     String?
  email       String?
  phone       String?

  // Adresse et géolocalisation
  street       String?
  streetNumber String?
  postalCode   String?
  city         String?
  latitude     Float?
  longitude    Float?

  // Google Business Integration
  googlePlaceId String?
  googleMapsUrl String?

  // Informations de partenariat
  partnerType PartnerType @default(COMMERCIAL)
  category    String?
  priority    Int         @default(0) // Pour l'ordre d'affichage

  // Statut
  isActive    Boolean @default(true)
  isFeatured  Boolean @default(false)

  // Dates importantes
  startDate   DateTime?
  endDate     DateTime?

  // Métadonnées
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?

  // Index pour les performances
  @@index([slug])
  @@index([partnerType])
  @@index([isActive])
  @@index([priority])
  @@index([createdAt])
  @@index([latitude, longitude])
  @@map("partner")
}

// Énumération pour les types de partenaires
enum PartnerType {
  COMMERCIAL    // Partenaire commercial
  INSTITUTIONAL // Partenaire institutionnel
  MEDIA         // Partenaire média
  TECHNICAL     // Partenaire technique
  SPONSOR       // Sponsor
  SUPPLIER      // Fournisseur
  OTHER         // Autre
}

// ============================================================
//                        HISTOIRE / CMS
// ============================================================

// Configuration générale de l'histoire
model HistoryConfig {
  id          String   @id @default(cuid())
  title       String   // Titre principal de la page
  subtitle    String?  // Sous-titre
  description String?  // Description meta
  heroImage   String?  // Image hero
  
  // Vision future
  visionTitle       String? // "Et demain ?"
  visionDescription String? // Description de la vision
  visionImage       String? // Image pour la vision
  
  // Boutons d'action
  primaryButtonText String? // "Découvrir nos partenaires"
  primaryButtonUrl  String? // URL du bouton principal
  secondaryButtonText String? // "Nous rejoindre"
  secondaryButtonUrl  String? // URL du bouton secondaire
  
  // Métadonnées
  isActive  Boolean  @default(true)
  updatedBy String   // ID de l'utilisateur qui a modifié
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  milestones      HistoryMilestone[]
  timelineEvents  HistoryTimelineEvent[]
  updatedByUser   User @relation(fields: [updatedBy], references: [id])
  
  @@map("history_config")
}

// Étapes importantes (chiffres clés)
model HistoryMilestone {
  id          String   @id @default(cuid())
  configId    String
  number      String   // "2019", "200+", etc.
  label       String   // "Année de création", etc.
  icon        String   // Nom de l'icône Lucide
  order       Int      // Ordre d'affichage
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  config HistoryConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  
  @@index([configId, order])
  @@map("history_milestone")
}

// Événements de la timeline
model HistoryTimelineEvent {
  id          String   @id @default(cuid())
  configId    String
  year        String   // "2019", "2020", etc.
  title       String   // "L'idée prend forme"
  description String   // Description détaillée
  icon        String   // Nom de l'icône Lucide
  color       String   // Classe CSS pour la couleur
  order       Int      // Ordre d'affichage
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  config HistoryConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  
  @@index([configId, order])
  @@map("history_timeline_event")
}

// ============================================================
//                      CHATBOT WHATSAPP
// ============================================================

// Conversations WhatsApp
model WhatsAppConversation {
  id          String   @id @default(cuid())
  phoneNumber String   // Numéro de téléphone du contact
  name        String?  // Nom du contact (optionnel)
  isActive    Boolean  @default(true)
  lastMessage DateTime @default(now())
  
  // Métadonnées
  metadata    Json?    // Informations supplémentaires sur le contact
  
  // Relations
  messages    WhatsAppMessage[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([phoneNumber])
  @@index([phoneNumber])
  @@index([isActive])
  @@index([lastMessage])
  @@map("whatsapp_conversations")
}

// Messages WhatsApp
model WhatsAppMessage {
  id             String   @id @default(cuid())
  conversationId String
  messageId      String?  // ID du message WhatsApp (optionnel)
  
  // Contenu du message
  content        String
  messageType    WhatsAppMessageType @default(TEXT)
  
  // Direction du message
  isFromBot      Boolean  @default(false)
  
  // Statut du message
  status         WhatsAppMessageStatus @default(PENDING)
  
  // Métadonnées
  metadata       Json?    // Pièces jointes, coordonnées, etc.
  
  // Relations
  conversation   WhatsAppConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([conversationId])
  @@index([messageId])
  @@index([isFromBot])
  @@index([status])
  @@index([createdAt])
  @@map("whatsapp_messages")
}

// Sessions de bot pour suivre le contexte
model WhatsAppBotSession {
  id             String   @id @default(cuid())
  phoneNumber    String   
  currentFlow    String?  // Flux actuel (ex: "search_place", "get_events")
  currentStep    String?  // Étape actuelle dans le flux
  context        Json?    // Contexte de la conversation (données temporaires)
  
  // État de la session
  isActive       Boolean  @default(true)
  expiresAt      DateTime // Expiration de la session
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@unique([phoneNumber])
  @@index([phoneNumber])
  @@index([isActive])
  @@index([expiresAt])
  @@map("whatsapp_bot_sessions")
}

// Configuration du chatbot
model WhatsAppBotConfig {
  id             String   @id @default(cuid())
  
  // Configuration générale
  isEnabled      Boolean  @default(true)
  welcomeMessage String   @default("Bonjour ! Je suis l'assistant d'ABC Bédarieux. Comment puis-je vous aider ?")
  
  // Messages prédéfinis
  messages       Json     // Messages pour différentes situations
  
  // Configuration des flux
  flows          Json     // Définition des flux conversationnels
  
  // Paramètres
  sessionTimeout Int      @default(3600) // Timeout en secondes
  maxMessages    Int      @default(100)  // Max messages par heure par utilisateur
  
  // Métadonnées
  updatedBy      String   // ID de l'admin qui a modifié
  updatedByUser  User     @relation(fields: [updatedBy], references: [id])
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@map("whatsapp_bot_config")
}

// Statistiques du chatbot
model WhatsAppBotStats {
  id               String   @id @default(cuid())
  date             DateTime @db.Date
  
  // Métriques quotidiennes
  totalMessages    Int      @default(0)
  totalUsers       Int      @default(0)
  newUsers         Int      @default(0)
  activeUsers      Int      @default(0)
  
  // Métriques par type
  textMessages     Int      @default(0)
  imageMessages    Int      @default(0)
  locationMessages Int      @default(0)
  contactMessages  Int      @default(0)
  
  // Métriques de flux
  searchQueries    Int      @default(0)
  eventQueries     Int      @default(0)
  placeQueries     Int      @default(0)
  helpRequests     Int      @default(0)
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@unique([date])
  @@index([date])
  @@map("whatsapp_bot_stats")
}

// ============================================================
//                      ENUMS WHATSAPP
// ============================================================

enum WhatsAppMessageType {
  TEXT
  IMAGE
  AUDIO
  VIDEO
  DOCUMENT
  LOCATION
  CONTACT
  STICKER
  INTERACTIVE
  BUTTON
  LIST
}

enum WhatsAppMessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
  EXPIRED
}

// ============================================================
//                    GOOGLE DRIVE OAUTH
// ============================================================

model GoogleDriveToken {
  id String @id @default(cuid())
  
  // OAuth tokens
  accessToken  String
  refreshToken String?
  scope        String
  tokenType    String @default("Bearer")
  expiresAt    DateTime?
  
  // Utilisateur qui a autorisé
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Informations Google
  googleUserId    String? // Google account ID
  googleEmail     String? // Google account email
  googleName      String? // Google account name
  
  // Dossier de sauvegarde
  backupFolderId   String? // ID du dossier de sauvegarde créé
  backupFolderName String? @default("ABC-Bedarieux-Backups")
  
  // Métadonnées
  isActive      Boolean  @default(true)
  lastUsedAt    DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("google_drive_tokens")
}

// ============================================================
//                    PARAMÈTRES DU SITE
// ============================================================

model SiteSettings {
  id String @id @default(cuid())

  // Informations générales
  siteName        String  @default("ABC Bédarieux")
  siteDescription String?
  siteUrl         String?
  contactEmail    String?
  contactPhone    String?

  // Réseaux sociaux
  facebookUrl  String?
  instagramUrl String?
  twitterUrl   String?
  linkedinUrl  String?
  youtubeUrl   String?
  tiktokUrl    String?

  // Adresse physique
  addressStreet String?
  addressCity   String?
  addressZip    String?

  // Horaires d'ouverture (JSON)
  openingHours Json?

  // Métadonnées
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("site_settings")
}
